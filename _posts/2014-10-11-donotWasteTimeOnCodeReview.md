#Don’t Waste Time on Code Review 不要在代码评审上浪费时间

	小于一半的研发团队执行code review，另一半没能从code review获得到什么。

	本文阐述了怎样不浪费时间在code review上。（代码评审）

##keep it simple  保持简单


许多人依然认为代码评审是**昂贵的正式代码检查会议**，并需要大量的前期工作，在一间满是评审者的房间里，围在一张桌子上，在主持人和秘书的帮助下，一起缓慢地走读代码。太麻烦，又延误，和大量的文书工作。

永远不要这样开展代码评审。

最近研究表明，执行正式代码检查会议只会给研发带来延期和成本，没有什么价值。通过数周安排的代码评审会议，只能发现4%的缺陷，其他的缺陷都是通过审查者自己走读代码发现的。

在微软和谷歌，研发人员不会出席正式代码检查会议。相反，他们利用协同平台进行代码评审，比如Gerrit，code flow，collaborator，review board或crucible，或是使用email请求异步审查，并和其他审查者交换信息。

轻量级的审查（做的恰当的话）对发现代码缺陷很有效，而且不昂贵并更易于安排和管理。他们经常使用这种方式。

这种审查更适合迭代的，增量式开发，为开发者提供更快的反馈（几小时，最多两天，而不是数周的正式检查）。

##keep the number of reviewers small 保持小数量的审查者


有人相信两个人的头脑要好于一个人的头脑，三个人的头脑更好，四个人更加好，以此类推。。。

那为什么不邀请团队的所有人参加代码评审呢？

答案是：__因为这是在可悲地浪费时间和金钱。__

正如任何实践，你将很快达到收益递减点，当你设法让更多的人看同样的代码。

平均来说，一个审查者自己就会找到近一半的缺陷。实际上，一项对cisco的研究表明，研发者自己两次检查（double-checked）他们自己的代码时，在没有审查者的帮助下，也会发现近一半的缺陷。

第二个审查者发现新问题的数量是第一个审查者发现的一半。除了这一点，就是在浪费时间和金钱。一项研究表明，3，4，5个人的团队，发现问题的数量是没有区别的。另一项研究表明2个人会做到比4个人更好。

这部分是由于重叠和冗余–更多的人意味着更多的人在寻找同样的问题（和更多的人出现假阳性结果，作者通过筛选）。

	正如杰夫女士在Atlassian解释说，有一个“社会惰化”问题：添加更多的审查者，只是自满和一种虚假的安全感。因为每个人都知道还有别人在看相同的代码，他们也就没什么压力去找问题。（自己发现不了，别人也能发现，大锅饭）

这也是为什么像google 和 microsoft成功地执行代码评审，评审者的中位数是2（尽管有作者要求更多的评审者，尤其是彼此之间意见不一致的情况下）

找到对的人评审代码，比确定评审者的最佳数量更重要。

##Code Reviews shouldn’t be done by nOObs - but they should be done for nOObs

通过审查其他人的代码，开发人员会接触到更多的代码库，并学习一些新的想法和技巧。但不要指望新的团队成员可以通过评审其他研发的代码，来了解系统的工作方式或真正了解编码规范和结构。让新团队成员审查的其他人的代码是一种糟糕的培养新人方式，和一种糟糕的代码评审方法。

研究反馈显而易见：代码评审的有效性依赖于评审者的技能，对问题域和代码的熟悉程度。同软件开发中的其他领域类似，评审有效性的差异是巨大的，最好和最差之间相差达10倍多。一项针对微软的代码评审研究发现，评论者是团队外部的或是新来的员工，在不了解代码或问题域的情况下，可能只会做表面工作去找格式上的问题或简单的逻辑错误。

**这意味着，你最好的开发者，团队领导和架构师会花很多时间做代码评审，而且他们应该这样做。需要擅长于阅读代码，调试，懂编程语言，框架和问题域的评审者。他们在发现问题上会做的更好，并能提供更多的有价值的反馈，包括建议如何更简单的或更有效的方法来解决问题，或如何更好的运用语言和框架。而且他们做事会更快。**

如果你想要一个新的开发者去了解代码、编码规范和体系结构，更有效的方法是让新的开发者与经验丰富的团队成员进行结对编程或调试。

如果你想要一个新的，没有经验的开发者做代码评审（比如你别无选择），请降低你的期望值。让他们检查直接的代码变化（不需要深入的评审），或者意识到需要依赖更多的静态分析工具和另一位评审者找到真正的问题。

##Substance over style 超出编码风格的本质

代码评审时只是关注编码规范是在浪费一个研发人员的宝贵时间。编码规范可以在早期解决，让每个人都在他们的IDE使用相同编码风格的模板，并使用工具，如CheckStyle保证代码格式一致。把评审者解放出来，集中精力在重要的事情上：帮助开发者编写更好的代码，代码的正确性和易于维护。
>
“我见过不少代码评审，只关注格式问题，而忽略了安全问题或数据模型的问题。”
>


在微软的高级工程师，对代码评审的实践研究表明:

正确性——确保代码可以准确工作（做它该做的事），寻找那些很难通过测试发现的bug：

* 功能正确性：代码是否做它应该做的——评审者需要知道问题域，需求和这部分的代码，从而有效地发现功能的正确性问题。

* 编码错误：低级编码错误，比如使用< =代替<，使用错误的变量（如混合了lessee 和 lessor），复制和粘贴错误，遗留调试代码。

* 设计错误：遗漏，不正确的假设，混淆架构和设计模式（MVC），滥用架构
安全和防御：数据验证，线程和并发（死锁和争用条件），错误处理和异常处理等问题

* 恶意代码：后门，定时炸弹或逻辑炸弹

* 安全（秘密）：严格实施安全和隐私控制（认证，访问控制，审计，加密）
可维护性：

* 清晰：类和方法和变量命名，注释，…

* 一致性：使用通用的规则，语言/功能库，而不是闭门造车，按照既定的规范和模式

* 组织：结构差，重复或不使用/死代码

* 方法：评审者可以看到一个简单的、简洁的、更有效的实现。

##Where should reviewers spend most of their time？评审者需要把绝大部分时间花在哪儿？

研究表明，评审者发现可维护性的问题的数量远超过发现缺陷（**大概75:25的比例**），花更多的时间在代码清晰和定义问题，而不是在修正问题。这有几个原因。

发现代码中的错误是很难的。在别人的代码中找到错误更难。

在许多情况下，评审者并不能发现问题或是提供有意义的解决问题方案。反而没有时间做好工作。所以他们选择容易的代码清晰问题，比如简陋的命名或格式不一致。

但即使是有经验的和严肃的评审者，也会陷入显而易见的命名或格式的小问题中，因为他们需要在他们能找到错误之前理解代码，通过这种方式，可以得到不难读的代码，并更容易发现重要问题。

这就是为什么程序员在微软有时会让2个不同评审者进行代码评审：一个表面的“代码清洁“，通过查看代码规范，代码清晰度和编辑问题，其次是一个更深入的代码评审，检查正确性问题，在代码被整理规范之后。

##use static analysis to make reviews more efficient 使用静态分析工具使评审更有效

利用静态分析工具进行前期代码评审更有效。至少可以使用一些免费工具，如Findbugs PMD，这类为Java捕捉常见编码错误和不一致，草率或凌乱的代码和死代码。在提交代码给别人评审之前，使用工具过滤一下。

这样可以把评审者从小错误和坏实践中解放出来，他们可以更关注于发现更高层次的错误。但请记住，静态分析只是帮助代码评审一个工具，不是替代。静态分析工具不能发现功能正确性问题或设计不一致性或遗漏，或帮助你找到一个更好的或更简单的方式来解决一个问题。

##Where is the risk？ 风险？
我们可能试图检查所有代码变化。但遵照80:20规则进行代码评审能给我们带来更多好处：*重点评审高风险的代码，和高风险的变化。*

高风险代码：

* 网络API
* 管道（框架代码，安全库…）
* 关键的业务逻辑和流程
* 指令、控制和root管理功能
* 临界安全性或性能的关键（特别是实时的）部分
* 代码处理私人或敏感的数据
* 旧的代码，复杂的代码，多人维护的代码，之前易出错的代码。

高风险的变化：

* 加入团队的人员编写的代码
* 大的变化
* 大范围重构（重新设计，被伪装成重构）

##Get the most out of code reviews 代码评审之外的收获
代码评审增加了开发成本，如果做的不恰当，会破坏生产力和疏远团队。但也是发现错误，开发者之间相互帮助，编写更好代码的重要途径。所以要正确地执行代码评审。

不要在会议，主持和文书上浪费时间。要尽早并经常做代码评审。保持尽可能紧密的反馈循环（代码评审要注重及时反馈）。
要求每个人严肃对待代码评审，包括开发者和审查者。避免互相攻击，或是互相袒护。

代码评审要简单，但不能马虎。要求评审者专注于真正重要的问题：正确性，使代码难以理解和维护的原因。不要浪费时间争论格式或样式。

确保你总是检查高风险的代码和高风险的代码变更。

用最好的人员来做代码评审，质量比数量更重要。

**记住，代码评审只是质量过程的一部分。以其让更多的人来做检查代码，不如把时间放在设计评审、编写更好的测试工具、更好的测试上更有价值。代码评审是件奢侈的事情。**


>
<http://server.dzone.com/articles/dont-waste-time-code-reviews>

	疯狂到以为自己能改变世界的人，才可能真正改变世界的人。


